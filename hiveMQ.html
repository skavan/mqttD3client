<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <title></title>
    <link type="text/css" rel="stylesheet" href="select2.min.css" />
    <link type="text/css" rel="stylesheet" href="topic-tree.css" />
    <script type="text/javascript" src="jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="d3.v5.js"></script>
    <script type="text/javascript" src="mqttws31.js"></script>
    <script type="text/javascript" src="select2.min.js"></script>
    <script type="text/javascript" src="topic-tree.js"></script>
</head>
<body>
    <div id="status">Loading</div>
    <div>
        <button onclick="fit('o')">Original</button>
        <button onclick="fit('in')">Fit inside</button>
        <button onclick="fit('w')">Fit width</button>
        <button onclick="fit('h')">Fit height</button>
        &nbsp;-&nbsp;
        <select id="ddlSearch" style="min-width: 400px;"></select>
    </div>
    <br />
    <div id="body" style="width: 900px; height: 800px;">
    </div>
    <script type="text/javascript">

        var options = {
            // host: 'test.mosquitto.org',
            // port: parseInt(8080),
			host: 'broker.hivemq.com',
			port: parseInt(8000),
            clientID: "web" + new Date().getTime(),
            connectOpts: {
                // userName: '',
                // password: '',
                // useSSL: true,
                keepAliveInterval: 30,
                timeout: 10,
                cleanSession: false,
                onSuccess: onConnect,
                onFailure: onFailure
            }
        }


        setup("body", $("#ddlSearch"));

        var client = new Paho.MQTT.Client(options.host, options.port, options.clientID);
        client.onMessageArrived = onMessage;
        client.onconnectionlost = onDisconnect;

        function onConnect() {
            client.subscribe('dragonfly/#', onMessage);
            document.getElementById('status').innerHTML = "&nbsp;";
            console.log("mqtt connected");
        }

        function onFailure() {
            document.getElementById('status').innerHTML = "failed to connect";
            reconnect();
        }

        client.connect(options.connectOpts);

        function onMessage(message) {
            //console.log(message.topic + "- " + message.payload);
            addNode(message.destinationName, message.payloadString);
        }

        function onDisconnect(reason) {
            console.log("disconnected - " + reason);
            //alert("disconnected - " + reason);
            document.getElementById('status').innerHTML = "Disconnected";
            reconnect();
        }

        function reconnect() {
            setTimeout(function () {
                document.getElementById('status').innerHTML = "reconnecting";
                client.connect(options.connectOpts);
            }, 3000);
        }
    </script>
</body>
</html>
